<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة السندات - BILL PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <!-- jsPDF for Client Side Printing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.6.0/dist/jspdf.plugin.autotable.js"></script>
</head>

<body>

    <div class="container animate-fade-in">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1>سندات الصرف</h1>
            <button class="btn btn-primary" onclick="openModal()" id="addBtn">+ إضافة سند</button>
        </div>

        <div class="card">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <input type="text" id="filterSupplier" placeholder="ابحث باسم المورد" class="form-control"
                    style="max-width: 200px;">
                <select id="filterBranch" class="form-control" style="max-width: 150px; display:none;">
                    <option value="">كل الفروع</option>
                </select>
                <input type="date" id="filterStart" class="form-control" style="max-width: 150px;">
                <input type="date" id="filterEnd" class="form-control" style="max-width: 150px;">
                <button onclick="loadVouchers()" class="btn btn-outline">بحث</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>رقم السند</th>
                            <th>التاريخ</th>
                            <th>المورد</th>
                            <th>الفرع</th> <!-- New Col -->
                            <th>المبلغ</th>
                            <th>طريقة الدفع</th>
                            <th>بواسطة</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="voucherTableBody">
                        <tr>
                            <td colspan="7" style="text-align:center">جاري التحميل...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;" id="pagination">
                <!-- Pagination Buttons -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="voucherModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card animate-fade-in" style="width: 100%; max-width: 500px; margin: 2rem;">
            <h2 id="modalTitle" style="margin-bottom: 1rem;">إضافة سند جديد</h2>
            <form id="voucherForm">
                <input type="hidden" id="voucherId">
                <div class="form-group">
                    <label class="form-label">تاريخ السند</label>
                    <input type="date" id="vDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">المورد</label>
                    <div style="position: relative; width: 100%;">
                        <input type="text" id="vSupplierSearch" class="form-control" placeholder="ابحث واختر المورد..."
                            autocomplete="off">
                        <input type="hidden" id="vSupplier">
                        <div id="supplierDropdownList" class="dropdown-list"
                            style="display:none; position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 100;">
                            <!-- Items will be injected here -->
                        </div>
                    </div>
                    <button type="button" onclick="window.location.href='/suppliers.html'" class="btn btn-outline"
                        style="font-size:0.8rem">إدارة</button>
                </div>
                <div class="form-group">
                    <label class="form-label">المبلغ</label>
                    <input type="number" step="0.01" id="vAmount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">طريقة الدفع</label>
                    <select id="vMethod" class="form-control">
                        <option value="Cash">نقد</option>
                        <option value="Check">شيك</option>
                        <option value="Transfer">تحويل بنكي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">البيان / الوصف</label>
                    <textarea id="vDesc" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">مقابل</label>
                    <select id="vPaymentFor" class="form-control" required>
                        <option value="تصفية حساب">تصفية حساب</option>
                        <option value="سداد فاتورة">سداد فاتورة</option>
                        <option value="جزء من حساب">جزء من حساب</option>
                    </select>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" onclick="closeModal()" class="btn btn-outline">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        let currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        window.vouchersData = [];

        // Show add button for all
        // if (currentUser.role === 'USER') {
        //     document.getElementById('addBtn').style.display = 'none';
        // }

        document.addEventListener('DOMContentLoaded', () => {
            loadSuppliers();
            if (currentUser.role === 'ADMIN' || (currentUser.permissions && currentUser.permissions.includes('manage_branches'))) {
                loadBranches();
            }
            loadVouchers();

            // Auto open modal if requested
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'new') {
                setTimeout(() => openModal(), 500);
            }
        });

        async function loadBranches() {
            try {
                const branches = await Api.getBranches();
                const sel = document.getElementById('filterBranch');
                sel.style.display = 'block';
                branches.forEach(b => {
                    sel.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        let allSuppliers = [];

        async function loadSuppliers() {
            try {
                allSuppliers = await Api.getSuppliers();
                renderSupplierDropdown(allSuppliers);
            } catch (e) { console.error(e); }
        }

        function renderSupplierDropdown(list) {
            const dropdown = document.getElementById('supplierDropdownList');
            dropdown.innerHTML = '';

            if (list.length === 0) {
                dropdown.innerHTML = '<div style="padding:0.5rem; text-align:center; color:var(--text-light)">لا يوجد نتائج</div>';
                return;
            }

            list.forEach(s => {
                const item = document.createElement('div');
                item.style.padding = '0.75rem';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid var(--border)';
                item.innerText = s.name;
                item.onmouseover = () => item.style.background = 'var(--bg-secondary)';
                item.onmouseout = () => item.style.background = 'transparent';

                item.onclick = () => {
                    document.getElementById('vSupplier').value = s.id;
                    document.getElementById('vSupplierSearch').value = s.name;
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(item);
            });
        }

        // Setup Search Listener
        const searchInput = document.getElementById('vSupplierSearch');
        const dropdownList = document.getElementById('supplierDropdownList');

        searchInput.addEventListener('focus', () => {
            dropdownList.style.display = 'block';
            renderSupplierDropdown(allSuppliers); // Show all on focus
        });

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = allSuppliers.filter(s => s.name.toLowerCase().includes(val));
            renderSupplierDropdown(filtered);
            dropdownList.style.display = 'block';

            // Clear ID if text changes to something not matching exactly (though we want them to select from list)
            // Ideally we keep the ID if the name matches, else clear it.
            // For now, let's clear ID on input to force selection
            document.getElementById('vSupplier').value = '';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
                dropdownList.style.display = 'none';
            }
        });

        async function loadVouchers(page = 1) {
            const supplier = document.getElementById('filterSupplier').value;
            const branchId = document.getElementById('filterBranch').value;
            const startDate = document.getElementById('filterStart').value;
            const endDate = document.getElementById('filterEnd').value;

            const tbody = document.getElementById('voucherTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">جاري التحميل...</td></tr>';

            try {
                const res = await Api.getVouchers({ page, supplier, startDate, endDate, branchId });
                window.vouchersData = res.data;
                tbody.innerHTML = '';

                if (res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">لا توجد بيانات</td></tr>';
                    return;
                }

                res.data.forEach(v => {
                    // Only show actions if allowed
                    let actionsHtml = '';
                    const perms = currentUser.permissions ? JSON.parse(currentUser.permissions) : [];

                    // Allow edit/delete if ADMIN or has specfic permission
                    // Check granular permissions (or ADMIN fallback)
                    const canEdit = currentUser.role === 'ADMIN' || perms.includes('edit_voucher');
                    const canDelete = currentUser.role === 'ADMIN' || perms.includes('delete_voucher');

                    if (canEdit) {
                        actionsHtml += `<button onclick="editVoucher(${v.id})" class="btn btn-outline" style="padding:0.25rem 0.5rem; font-size: 0.8rem;">تعديل</button>`;
                    }
                    if (canDelete) {
                        actionsHtml += ` <button onclick="deleteVoucher(${v.id})" class="btn btn-danger" style="padding:0.25rem 0.5rem; font-size: 0.8rem;">حذف</button>`;
                    }

                    const row = document.createElement('tr');
                    const branchName = v.branch ? v.branch.name : '-';
                    // Use createdAt for exact time if available, else date (fallback)
                    const timeObj = v.createdAt ? new Date(v.createdAt) : new Date(v.date);
                    const timeStr = timeObj.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = new Date(v.date).toLocaleDateString('ar-EG');

                    row.innerHTML = `
                        <td>${v.voucherNo}</td>
                        <td dir="ltr" style="text-align:right">${dateStr} <span style="color:#666; font-size:0.8em; margin-right:5px;">${timeStr}</span></td>
                        <td>${v.supplier || v.supplierName || '-'}</td>
                        <td>${branchName}</td>
                        <td style="font-weight:bold; color: var(--primary);">${parseFloat(v.amount).toLocaleString()}</td>
                        <td>${v.paymentMethod}</td>
                        <td>${v.createdBy ? v.createdBy.fullName : '-'}</td>
                        <td>
                            ${actionsHtml}
                            <button onclick='printVoucher(${JSON.stringify(v).replace(/'/g, "&#39;")})' class="btn btn-primary" style="padding:0.25rem 0.5rem; font-size: 0.8rem;">طباعة</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Simple Pagination
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                if (res.totalPages > 1) {
                    if (page > 1) pagination.innerHTML += `<button onclick="loadVouchers(${page - 1})" class="btn btn-outline">السابق</button>`;
                    pagination.innerHTML += `<span style="padding: 0.5rem;">صفحة ${page} من ${res.totalPages}</span>`;
                    if (page < res.totalPages) pagination.innerHTML += `<button onclick="loadVouchers(${page + 1})" class="btn btn-outline">التالي</button>`;
                }

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red">${error.message}</td></tr>`;
            }
        }

        function methodAr(m) {
            const map = { 'Cash': 'نقد', 'Check': 'شيك', 'Transfer': 'تحويل' };
            return map[m] || m;
        }

        // Modal Logic
        const modal = document.getElementById('voucherModal');
        const form = document.getElementById('voucherForm');

        function openModal(isEdit = false) {
            modal.style.display = 'flex';
            if (!isEdit) {
                document.getElementById('modalTitle').innerText = 'إضافة سند جديد';
                form.reset();
                document.getElementById('voucherId').value = '';
                document.getElementById('vDate').valueAsDate = new Date(); // Default today
                // Clear searchable inputs
                document.getElementById('vSupplier').value = '';
                document.getElementById('vSupplierSearch').value = '';
            }
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) closeModal();
        }

        // Create / Update
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('voucherId').value;
            const data = {
                date: document.getElementById('vDate').value,
                supplierId: document.getElementById('vSupplier').value,
                amount: parseFloat(document.getElementById('vAmount').value),
                paymentMethod: document.getElementById('vMethod').value,
                description: document.getElementById('vDesc').value,
                paymentFor: document.getElementById('vPaymentFor').value
            };

            if (!data.supplierId) {
                alert('الرجاء اختيار مورد من القائمة');
                return;
            }

            try {
                if (id) {
                    await Api.updateVoucher(id, data);
                    alert('تم التعديل بنجاح');
                } else {
                    await Api.createVoucher(data);
                    alert('تم الإضافة بنجاح');
                }
                closeModal();
                loadVouchers();
            } catch (err) {
                alert(err.message);
            }
        });

        window.editVoucher = (id) => {
            const voucher = window.vouchersData.find(v => v.id === id);
            if (!voucher) return alert('خطأ: السند غير موجود');

            openModal(true);
            document.getElementById('modalTitle').innerText = 'تعديل سند ' + voucher.voucherNo;
            document.getElementById('voucherId').value = voucher.id;
            document.getElementById('vDate').value = new Date(voucher.date).toISOString().split('T')[0];

            // Set Supplier Select
            document.getElementById('vSupplier').value = voucher.supplierId || '';
            const supName = voucher.supplier || voucher.supplierName || '';
            document.getElementById('vSupplierSearch').value = supName;

            document.getElementById('vAmount').value = voucher.amount;
            document.getElementById('vMethod').value = voucher.paymentMethod;
            document.getElementById('vDesc').value = voucher.description || '';
        };


        window.deleteVoucher = async (id) => {
            if (confirm('هل أنت متأكد من الحذف؟')) {
                try {
                    await Api.deleteVoucher(id);
                    loadVouchers();
                } catch (err) { alert(err.message); }
            }
        };

        // Initialize global settings
        window.companySettings = {
            name: 'BILL PRO',
            logo: null
        };

        // Fetch settings on load
        async function loadSettings() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const res = await fetch('/api/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.company_name) window.companySettings.name = data.company_name;
                    if (data.company_logo) window.companySettings.logo = data.company_logo;
                }
            } catch (e) { console.error('Failed to load settings', e); }
        }

        // Add to DOMContentLoaded
        const originalInit = document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            // ... existing init code (it will run in parallel usually or I can overwrite)
            // Since I can't overwrite the existing event listener easily without replacing it,
            // I'll just add this one.
        });

        // Convert number to Arabic words
        function numberToArabicWords(num) {
            if (!num || num === 0) return 'صفر';

            const ones = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const tens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مئتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            const teens = ['عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];

            num = Math.floor(num); // Remove decimals
            if (num >= 1000000) return num.toLocaleString('ar-SA') + ' ريال'; // Too large, show as number

            let result = '';

            // Thousands
            const thousands = Math.floor(num / 1000);
            if (thousands > 0) {
                if (thousands === 1) result += 'ألف';
                else if (thousands === 2) result += 'ألفان';
                else if (thousands <= 10) result += ones[thousands] + ' آلاف';
                else result += numberToArabicWords(thousands) + ' ألف';
                result += ' و';
            }

            num = num % 1000;

            // Hundreds
            const hundred = Math.floor(num / 100);
            if (hundred > 0) {
                result += hundreds[hundred];
                if (num % 100 > 0) result += ' و';
            }

            num = num % 100;

            // Tens and ones (ones first)
            if (num >= 10 && num < 20) {
                result += teens[num - 10];
            } else {
                const ten = Math.floor(num / 10);
                const one = num % 10;

                // Write ones first
                if (one > 0) {
                    result += ones[one];
                    if (ten > 0) result += ' و';
                }

                // Then tens
                if (ten > 0) {
                    result += tens[ten];
                }
            }

            return result + ' ريالاً';
        }

        // Overwrite printVoucher
        window.printVoucher = (v) => {
            const printWindow = window.open('', '_blank', 'width=800,height=600');

            const supplierName = v.supplier || v.supplierName || '-';
            const creatorName = v.createdBy ? v.createdBy.fullName : '-';

            // Branch
            const branchName = v.branch ? v.branch.name : '';

            // Format time
            const timeObj = v.createdAt ? new Date(v.createdAt) : new Date();
            const timeStr = timeObj.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            const dateStr = new Date(v.date).toLocaleDateString('ar-EG');

            // Header Content
            const companyName = window.companySettings.name;
            const logoHtml = window.companySettings.logo
                ? `<img src="${window.companySettings.logo}" style="height: 80px; margin-bottom: 0.5rem;">`
                : '';

            printWindow.document.write(`
                <html dir="rtl" lang="ar">
                <head>
                    <title>سند صرف ${v.voucherNo}</title>
                    <style>
                        body { font-family: 'Tajawal', sans-serif; padding: 2rem; direction: rtl; }
                        .header-container { text-align: center; border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 2rem; position: relative; }
                        .company-info { font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0; }
                        .doc-title { margin-top: 1rem; font-size: 2rem; border: 2px solid #000; display: inline-block; padding: 0.5rem 2rem; border-radius: 8px; }
                        
                        .row { display: flex; margin-bottom: 1rem; align-items: baseline; }
                        .label { font-weight: bold; width: 140px; font-size: 1.1rem; }
                        .value { flex: 1; border-bottom: 1px dotted #ccc; font-size: 1.1rem; padding-bottom: 2px; }
                        .amount-box { border: 2px solid #333; padding: 0.5rem 2rem; text-align: center; font-size: 1.5rem; margin: 1rem 0; float: left; border-radius: 8px; font-weight: bold; background: #f9f9f9; }
                        .footer { margin-top: 4rem; display: flex; justify-content: space-between; text-align: center; }
                        .footer div { min-width: 150px; }
                        .footer p { font-weight: bold; margin-bottom: 3rem; }
                    </style>
                     <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                </head>
                <body>
                    <div class="header-container">
                        ${logoHtml}
                        <div class="company-info">${companyName}</div>
                        ${branchName ? `<div>فرع: ${branchName}</div>` : ''}
                        
                        <div class="doc-title">سند صرف نقدية</div>
                    </div>
                    
                    <div style="overflow: hidden; margin-bottom: 2rem;">
                         <div style="float: right;">
                            <div><strong>رقم السند:</strong> ${v.voucherNo}</div>
                            <div style="margin-top:0.5rem;"><strong>التاريخ:</strong> ${dateStr}</div>
                         </div>
                         <div class="amount-box">
                            ${parseFloat(v.amount).toLocaleString()} ريال
                         </div>
                    </div>
                    
                    <div class="row">
                        <span class="label">اصرفوا للمكرم/ </span>
                        <span class="value">${supplierName}</span>
                    </div>
                    
                    <div class="row">
                        <span class="label">مبلغاً وقدره/ </span>
                        <span class="value">${numberToArabicWords(v.amount)}</span>
                    </div>

                    <div class="row">
                        <span class="label">وذلك مقابل/ </span>
                        <span class="value">${v.description || ''}</span>
                    </div>
                    
                    ${v.paymentFor ? `<div class="row">
                        <span class="label">نوع المقابل/ </span>
                        <span class="value">${v.paymentFor}</span>
                    </div>` : ''}
                    
                    <div class="row">
                        <span class="label">طريقة الدفع/ </span>
                        <span class="value">${methodAr(v.paymentMethod)}</span>
                    </div>
                    
                    <div class="footer">
                        <div>
                            <p>المستلم</p>
                            ....................
                        </div>
                        <div>
                            <p>المحاسب</p>
                            ${creatorName}
                        </div>
                        <div>
                            <p>المدير المالي</p>
                            ....................
                        </div>
                        <div>
                            <p>اعتماد المدير العام</p>
                            ....................
                        </div>
                    </div>
                    
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

    </script>
</body>

</html>