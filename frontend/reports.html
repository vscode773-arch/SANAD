<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير - BILL PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <style>
        @media print {
            body {
                background: white;
            }

            .no-print,
            .btn,
            input,
            select,
            label,
            .navbar {
                display: none !important;
            }

            .card {
                box-shadow: none;
                border: none;
                padding: 0;
            }

            .container {
                padding: 0;
                max-width: 100%;
                margin: 0;
            }

            h1 {
                display: none;
            }

            #printHeader {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                border-bottom: 2px solid #eee;
                padding-bottom: 1rem;
            }

            .print-logo {
                max-height: 80px;
            }

            /* Show filter values instead of inputs */
            .print-only-filters {
                display: block !important;
                margin-bottom: 1rem;
            }
        }

        #printHeader,
        .print-only-filters {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container animate-fade-in">
        <!-- Print Header -->
        <div id="printHeader">
            <div style="text-align: right;">
                <h2 id="printCompanyName" style="margin:0; color:var(--primary);">اسم الشركة</h2>
                <p style="margin:0; color:#666;">تقرير الملخص المالي</p>
            </div>
            <img id="printLogo" src="" alt="Logo" class="print-logo" onerror="this.style.display='none'">
        </div>

        <h1 class="no-print">التقارير والسجلات</h1>

        <div style="margin-bottom: 2rem;" class="no-print">
            <button onclick="showSection('summary')" class="btn btn-primary" id="btn-summary">الملخص المالي</button>
            <button onclick="showSection('audit')" class="btn btn-outline" id="btn-audit">سجل النشاطات</button>
        </div>

        <!-- Summary Section -->
        <div id="section-summary" class="animate-fade-in">
            <div class="card">
                <h2 class="no-print">الملخص المالي</h2>

                <!-- Print Only Filter Info -->
                <div class="print-only-filters">
                    <p><strong>من تاريخ:</strong> <span id="pStart">-</span> &nbsp;&nbsp; <strong>إلى تاريخ:</strong>
                        <span id="pEnd">-</span>
                    </p>
                </div>

                <div class="no-print" style="display: flex; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                    <div>
                        <label class="form-label">من تاريخ</label>
                        <input type="date" id="repStart" class="form-control">
                    </div>
                    <div>
                        <label class="form-label">إلى تاريخ</label>
                        <input type="date" id="repEnd" class="form-control">
                    </div>
                    <div id="branchFilterDiv" style="display:none;">
                        <label class="form-label">الفرع</label>
                        <select id="repBranch" class="form-control" style="min-width: 120px;">
                            <option value="">كل الفروع</option>
                        </select>
                    </div>
                    <button onclick="loadSummary()" class="btn btn-primary">عرض التقرير</button>
                    <button onclick="window.print()" class="btn btn-outline">طباعة</button>
                </div>

                <div
                    style="background: #f8fafc; padding: 2rem; border-radius: 1rem; text-align: center; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; border: 1px solid #eee;">
                    <div>
                        <h3>إجمالي الصرف</h3>
                        <p id="repAmount" style="font-size: 3rem; color: var(--primary); font-weight: bold;">0</p>
                    </div>
                    <div>
                        <h3>عدد العمليات</h3>
                        <p id="repCount" style="font-size: 3rem; color: var(--text); font-weight: bold;">0</p>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">آخر العمليات</h3>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background:#f1f5f9;">
                                <th style="padding:10px; border:1px solid #ddd;">رقم السند</th>
                                <th style="padding:10px; border:1px solid #ddd;">التاريخ</th>
                                <th style="padding:10px; border:1px solid #ddd;">المورد</th>
                                <th style="padding:10px; border:1px solid #ddd;">المبلغ</th>
                            </tr>
                        </thead>
                        <tbody id="repRecentBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Audit Section -->
        <div id="section-audit" class="animate-fade-in" style="display: none;">
            <div class="card">
                <h2>سجل النشاطات (Audit Log)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>المستخدم</th>
                                <th>الحدث</th>
                                <th>الكيان</th>
                                <th>التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody id="auditBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.role === 'ADMIN' || (user.permissions && user.permissions.includes('manage_branches'))) {
                loadBranches();
            }
            loadSummary(); // Load default
            loadAudit();
            loadCompanyInfo();
        });

        async function loadBranches() {
            try {
                const branches = await Api.getBranches();
                const sel = document.getElementById('repBranch');
                document.getElementById('branchFilterDiv').style.display = 'block';
                branches.forEach(b => {
                    sel.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        function showSection(sec) {
            document.getElementById('section-summary').style.display = sec === 'summary' ? 'block' : 'none';
            document.getElementById('section-audit').style.display = sec === 'audit' ? 'block' : 'none';

            document.getElementById('btn-summary').className = sec === 'summary' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-audit').className = sec === 'audit' ? 'btn btn-primary' : 'btn btn-outline';
        }

        async function loadSummary() {
            const start = document.getElementById('repStart').value;
            const end = document.getElementById('repEnd').value;
            const branchId = document.getElementById('repBranch').value;

            // Update Print Info
            document.getElementById('pStart').innerText = start || 'الكل';
            document.getElementById('pEnd').innerText = end || 'الكل';

            try {
                const data = await Api.getSummary({ startDate: start, endDate: end, branchId });
                document.getElementById('repAmount').innerText = parseFloat(data.totalAmount).toLocaleString() + ' ر.س';
                document.getElementById('repCount').innerText = data.transactionCount;

                const tbody = document.getElementById('repRecentBody');
                tbody.innerHTML = '';
                data.recentTransactions.forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td style="padding:10px; border:1px solid #ddd;">${t.voucherNo}</td>
                            <td style="padding:10px; border:1px solid #ddd;">${new Date(t.date).toLocaleDateString('ar-EG')}</td>
                            <td style="padding:10px; border:1px solid #ddd;">${t.supplier}</td>
                            <td style="padding:10px; border:1px solid #ddd;">${parseFloat(t.amount).toLocaleString()}</td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function loadCompanyInfo() {
            try {
                const settings = await Api.getSettings();
                const logoSetting = settings.find(s => s.key === 'company_logo');
                const nameSetting = settings.find(s => s.key === 'company_name');

                if (logoSetting && logoSetting.value) {
                    document.getElementById('printLogo').src = logoSetting.value;
                } else {
                    document.getElementById('printLogo').style.display = 'none';
                }

                if (nameSetting && nameSetting.value) {
                    document.getElementById('printCompanyName').innerText = nameSetting.value;
                    document.title = 'تقرير - ' + nameSetting.value;
                }
            } catch (e) { console.error('Error loading company info', e); }
        }

        async function loadAudit() {
            try {
                const logs = await Api.getAuditLogs();
                const tbody = document.getElementById('auditBody');
                tbody.innerHTML = '';
                logs.forEach(l => {
                    tbody.innerHTML += `
                        <tr>
                            <td dir="ltr" style="text-align:right">${new Date(l.timestamp).toLocaleString('ar-EG')}</td>
                            <td>${l.user.username}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; background: ${getActionColor(l.action)}; color: white; font-size: 0.8rem;">${l.action}</span></td>
                            <td>${l.entity}</td>
                            <td>${l.details}</td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error(e); // Likely 403 if not admin
                if (e.message.includes('403') || e.message.includes('401')) {
                    document.getElementById('auditBody').innerHTML = '<tr><td colspan="5">غير مصرح لك بعرض السجل</td></tr>';
                }
            }
        }

        function getActionColor(action) {
            if (action === 'CREATE') return 'green';
            if (action === 'UPDATE') return 'orange';
            if (action === 'DELETE') return 'red';
            return 'gray';
        }
    </script>
</body>

</html>