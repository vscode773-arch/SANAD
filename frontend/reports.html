<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير - BILL PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <style>
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            body {
                background: white;
                font-family: 'Tajawal', sans-serif;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print,
            .btn,
            input,
            select,
            label,
            .navbar {
                display: none !important;
            }

            .card {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }

            .container {
                padding: 0;
                max-width: 100%;
                width: 100%;
                margin: 0;
            }

            #printHeader {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                border-bottom: 2px solid #000;
                padding-bottom: 1rem;
            }

            .print-logo {
                max-height: 80px;
                object-fit: contain;
            }

            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-top: 1rem;
                font-size: 12px;
            }

            th,
            td {
                border: 1px solid #000 !important;
                padding: 8px !important;
                text-align: center !important;
            }

            th {
                background-color: #f0f0f0 !important;
                font-weight: bold;
            }

            /* Show filter values instead of inputs */
            .print-only-filters {
                display: block !important;
                border: 1px solid #eee;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 1rem;
            }
        }

        #printHeader,
        .print-only-filters {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container animate-fade-in">
        <!-- Print Header -->
        <div id="printHeader">
            <div style="text-align: right;">
                <h2 id="printCompanyName" style="margin:0; color:var(--primary);">BILL PRO</h2>
                <p style="margin:0; color:#333;">تقرير الملخص المالي</p>
            </div>
            <img id="printLogo" src="assets/images/logo.png" alt="Logo" class="print-logo">
        </div>

        <h1 class="no-print">التقارير والسجلات</h1>

        <div style="margin-bottom: 2rem;" class="no-print">
            <button onclick="showSection('summary')" class="btn btn-primary" id="btn-summary">الملخص المالي</button>
            <button onclick="showSection('audit')" class="btn btn-outline" id="btn-audit">سجل النشاطات</button>
        </div>

        <!-- Summary Section -->
        <div id="section-summary" class="animate-fade-in">
            <div class="card">
                <h2 class="no-print">الملخص المالي</h2>

                <!-- Print Only Filter Info -->
                <div class="print-only-filters">
                    <p style="margin: 0;">
                        <strong>التاريخ:</strong> <span id="pStart"></span> - <span id="pEnd"></span>
                        &nbsp;|&nbsp;
                        <strong>تاريخ الطباعة:</strong> <span id="pDate"></span>
                    </p>
                </div>

                <div class="no-print filter-container"
                    style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <label class="form-label">من تاريخ</label>
                        <input type="date" id="repStart" class="form-control" style="width: 100%;">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label class="form-label">إلى تاريخ</label>
                        <input type="date" id="repEnd" class="form-control" style="width: 100%;">
                    </div>
                    <div id="branchFilterDiv" style="display:none; flex: 1; min-width: 150px;">
                        <label class="form-label">الفرع</label>
                        <select id="repBranch" class="form-control" style="width: 100%;">
                            <option value="">كل الفروع</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex: 1; min-width: 200px;">
                        <button onclick="loadSummary()" class="btn btn-primary" style="flex: 1;">عرض التقرير</button>
                        <button onclick="window.print()" class="btn btn-outline" style="flex: 1;">طباعة</button>
                    </div>
                </div>

                <div class="stats-grid"
                    style="background: #f8fafc; padding: 2rem; border-radius: 1rem; text-align: center; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; border: 1px solid #eee;">
                    <div>
                        <h3>إجمالي الصرف</h3>
                        <p id="repAmount"
                            style="font-size: 2.5rem; color: var(--primary); font-weight: bold; word-break: break-word;">
                            0</p>
                    </div>
                    <div>
                        <h3>عدد العمليات</h3>
                        <p id="repCount" style="font-size: 2.5rem; color: var(--text); font-weight: bold;">0</p>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">آخر العمليات</h3>
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 500px;">
                        <thead>
                            <tr style="background:#f1f5f9;">
                                <th>رقم السند</th>
                                <th>التاريخ</th>
                                <th>المورد</th>
                                <th>المبلغ</th>
                            </tr>
                        </thead>
                        <tbody id="repRecentBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Audit Section -->
        <div id="section-audit" class="animate-fade-in" style="display: none;">
            <div class="card">
                <h2>سجل النشاطات (Audit Log)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>المستخدم</th>
                                <th>الحدث</th>
                                <th>الكيان</th>
                                <th>التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody id="auditBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.role === 'ADMIN' || (user.permissions && user.permissions.includes('manage_branches'))) {
                loadBranches();
            }
            loadSummary(); // Load default
            loadAudit();
            loadCompanyInfo();
            // Set Print Date
            document.getElementById('pDate').innerText = new Date().toLocaleDateString('ar-EG');
        });

        async function loadBranches() {
            try {
                const branches = await Api.getBranches();
                const sel = document.getElementById('repBranch');
                document.getElementById('branchFilterDiv').style.display = 'block';
                branches.forEach(b => {
                    sel.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        function showSection(sec) {
            document.getElementById('section-summary').style.display = sec === 'summary' ? 'block' : 'none';
            document.getElementById('section-audit').style.display = sec === 'audit' ? 'block' : 'none';

            document.getElementById('btn-summary').className = sec === 'summary' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-audit').className = sec === 'audit' ? 'btn btn-primary' : 'btn btn-outline';
        }

        async function loadSummary() {
            const start = document.getElementById('repStart').value;
            const end = document.getElementById('repEnd').value;
            const branchId = document.getElementById('repBranch').value;

            // Update Print Info
            document.getElementById('pStart').innerText = start || 'الكل';
            document.getElementById('pEnd').innerText = end || 'الكل';

            try {
                const data = await Api.getSummary({ startDate: start, endDate: end, branchId });
                document.getElementById('repAmount').innerText = parseFloat(data.totalAmount).toLocaleString() + ' ر.س';
                document.getElementById('repCount').innerText = data.transactionCount;

                const tbody = document.getElementById('repRecentBody');
                tbody.innerHTML = '';
                data.recentTransactions.forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${t.voucherNo}</td>
                            <td>${new Date(t.date).toLocaleDateString('ar-EG')}</td>
                            <td>${t.supplier}</td>
                            <td>${parseFloat(t.amount).toLocaleString()}</td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function loadCompanyInfo() {
            try {
                const settings = await Api.getSettings();
                const logoSetting = settings.find(s => s.key === 'company_logo');
                const nameSetting = settings.find(s => s.key === 'company_name');

                // Default logo is assets/images/logo.png, override if setting exists
                if (logoSetting && logoSetting.value) {
                    document.getElementById('printLogo').src = logoSetting.value;
                }

                // Show logo if src is valid, no need to hide on error, just keeps fallback or empty

                if (nameSetting && nameSetting.value) {
                    document.getElementById('printCompanyName').innerText = nameSetting.value;
                    document.title = 'تقرير - ' + nameSetting.value;
                }
            } catch (e) {
                console.error('Error loading company info, using defaults', e);
                // In case of error, defaults in HTML (BILL PRO and fallback image) will stay
            }
        }

        async function loadAudit() {
            try {
                const logs = await Api.getAuditLogs();
                const tbody = document.getElementById('auditBody');
                tbody.innerHTML = '';
                logs.forEach(l => {
                    tbody.innerHTML += `
                        <tr>
                            <td dir="ltr" style="text-align:right">${new Date(l.timestamp).toLocaleString('ar-EG')}</td>
                            <td>${l.user.username}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; background: ${getActionColor(l.action)}; color: white; font-size: 0.8rem;">${l.action}</span></td>
                            <td>${l.entity}</td>
                            <td>${l.details}</td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error(e); // Likely 403 if not admin
                if (e.message.includes('403') || e.message.includes('401')) {
                    document.getElementById('auditBody').innerHTML = '<tr><td colspan="5">غير مصرح لك بعرض السجل</td></tr>';
                }
            }
        }

        function getActionColor(action) {
            if (action === 'CREATE') return 'green';
            if (action === 'UPDATE') return 'orange';
            if (action === 'DELETE') return 'red';
            return 'gray';
        }
    </script>
</body>

</html>